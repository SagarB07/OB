<?xml version="1.0"?>
  <database name="FUNCTION NO_COPIA_RPERFIL_RCEMPLEADO">
    <function name="NO_COPIA_RPERFIL_RCEMPLEADO" type="NULL">
      <parameter name="p_pinstance_id" type="VARCHAR" mode="in">
        <default/>
      </parameter>
      <body><![CDATA[v_ResultStr VARCHAR(2000):=''; 
v_Message VARCHAR(2000):=''; 
ITERADOR_RCUENTA RECORD;
ITERADOR_PERFIL RECORD;

BEGIN
   
   DBMS_OUTPUT.PUT_LINE('Updating PInstance - Processing ' || p_PInstance_ID);
  v_ResultStr:='PInstanceNotFound';
  AD_UPDATE_PINSTANCE(p_PInstance_ID, NULL, 'Y', NULL, NULL);
         
   FOR ITERADOR_PERFIL IN
					
			SELECT ne_perfil_rubro_id AS ID,
			NO_TIPO_INGRESO_EGRESO_ID AS RUBRO, 
			ne_debe_acct AS HABER, 
			ne_haber_acct  AS DEBE
			FROM NE_PERFIL_RUBRO_LINE 
			WHERE ISACTIVE = 'Y'          
			AND NE_PERFIL_RUBRO_LINE_ID IN (
				SELECT NE_PERFIL_RUBRO_LINE_ID FROM NE_PERFIL_RUBRO_LINE WHERE NE_PERFIL_RUBRO_ID IN (
							SELECT EM_NE_PERFIL_RUBRO_ID FROM C_BPARTNER WHERE C_BPARTNER_ID IN (
							SELECT C_BPARTNER_ID FROM no_cb_empleado_acct WHERE CREATED <> UPDATED 
							)
							)
			)
			
        LOOP


			FOR ITERADOR_RCUENTA IN
				SELECT 
				no_cb_empleado_acct_ID AS ID, 
				NO_CUENTA_EGRESO_ACCT AS HABER,
				NO_CUENTA_INGRESO_ACCT AS DEBE 
				FROM no_cb_empleado_acct 
				WHERE CREATED <> UPDATED 
				AND NO_TIPO_INGRESO_EGRESO_ID = ITERADOR_PERFIL.RUBRO
			LOOP
			
			IF ITERADOR_PERFIL.DEBE<>ITERADOR_RCUENTA.DEBE  THEN
			UPDATE IDT_CONTRATO SET I_ERRORMSG = '1';
			UPDATE no_cb_empleado_acct  SET NO_CUENTA_EGRESO_ACCT = ITERADOR_PERFIL.DEBE, 
			UPDATED = CREATED,
			NO_CUENTA_INGRESO_ACCT=ITERADOR_PERFIL.HABER  
			WHERE no_cb_empleado_acct_ID = ITERADOR_RCUENTA.ID ;
			END IF;
		
			IF ITERADOR_PERFIL.HABER<> ITERADOR_RCUENTA.HABER  THEN
			UPDATE IDT_CONTRATO SET I_ERRORMSG = '2';
			UPDATE no_cb_empleado_acct  SET NO_CUENTA_EGRESO_ACCT = ITERADOR_PERFIL.DEBE,
			NO_CUENTA_INGRESO_ACCT=ITERADOR_PERFIL.HABER,  
			UPDATED = CREATED
			WHERE no_cb_empleado_acct_ID = ITERADOR_RCUENTA.ID ;
			END IF;
			
			IF ITERADOR_PERFIL.HABER IS NULL THEN
			UPDATE IDT_CONTRATO SET I_ERRORMSG = '3';
			UPDATE no_cb_empleado_acct  SET NO_CUENTA_EGRESO_ACCT = ITERADOR_PERFIL.DEBE,
			NO_CUENTA_INGRESO_ACCT=ITERADOR_PERFIL.HABER,  
			UPDATED = CREATED
			WHERE no_cb_empleado_acct_ID = ITERADOR_RCUENTA.ID ;
			END IF;
			
			IF ITERADOR_PERFIL.DEBE IS NULL THEN
			UPDATE IDT_CONTRATO SET I_ERRORMSG = '4';
			UPDATE no_cb_empleado_acct  SET NO_CUENTA_EGRESO_ACCT = ITERADOR_PERFIL.DEBE, 
			NO_CUENTA_INGRESO_ACCT=ITERADOR_PERFIL.HABER,  
			UPDATED = CREATED
			WHERE no_cb_empleado_acct_ID = ITERADOR_RCUENTA.ID ;
			END IF;
			
			END LOOP;	
		
       END LOOP;
 	
	
         v_Message:='@NO_EjecucionCorrecta@';
        DBMS_OUTPUT.PUT_LINE('Updating PInstance - Finished - ' || v_Message);
        AD_UPDATE_PINSTANCE(p_PInstance_ID, '100', 'Y', null, v_Message);
        RETURN;
  
  RETURN;
   EXCEPTION
    WHEN OTHERS THEN
        v_ResultStr:= '@ERROR=' || SQLERRM;        
	DBMS_OUTPUT.PUT_LINE('Updating PInstance - Finished - ' || v_Message);
        AD_UPDATE_PINSTANCE(p_PInstance_ID, '100', 'Y', 0, v_Message);
        AD_UPDATE_PINSTANCE(p_PInstance_ID, NULL, 'N', 0, v_ResultStr);
    RETURN;
END NO_COPIA_RPERFIL_RCEMPLEADO
]]></body>
    </function>
  </database>
