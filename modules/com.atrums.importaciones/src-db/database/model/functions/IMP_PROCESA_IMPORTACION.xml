<?xml version="1.0"?>
  <database name="FUNCTION IMP_PROCESA_IMPORTACION">
    <function name="IMP_PROCESA_IMPORTACION" type="NULL">
      <parameter name="p_pinstance_id" type="VARCHAR" mode="in">
        <default/>
      </parameter>
      <body><![CDATA[v_ResultStr VARCHAR(2000):=''; 
    v_Message VARCHAR(2000):=''; 
    v_Record_ID VARCHAR(32); 
    v_Result NUMBER:=1; 


    Cur_Parameter RECORD;
    Cur_TodasFacturas RECORD;
    Cur_IndividualFacturas RECORD;

    v_Client_ID VARCHAR(32); 
    v_Org_ID VARCHAR(32); 
    v_User_ID VARCHAR(32); 
    v_Parameter VARCHAR(60):='';
    v_Fecha DATE;

    v_imp_total_procesar_id VARCHAR(32):=''; 
    v_cco_cuenta_costos_id VARCHAR(32):='';
    v_m_costing_id VARCHAR(32):='';
    v_value VARCHAR(40):='';
    v_name VARCHAR(60):='';
    v_total_gasto NUMBER;
    v_procesado VARCHAR(1):='';

    v_total_cant_factura NUMBER;
    v_total_imp NUMBER;
    v_gasto_imp NUMBER;
    v_porcentaje_gasto NUMBER;
    v_costo NUMBER;

    v_cost_costing NUMBER:=0;
    v_stock NUMBER;

BEGIN
   
    DBMS_OUTPUT.PUT_LINE('Updating PInstance - Processing ' || p_PInstance_ID);
    v_ResultStr:='PInstanceNotFound';
    AD_UPDATE_PINSTANCE(p_PInstance_ID, NULL, 'Y', NULL, NULL);
    
    BEGIN 
    
DBMS_OUTPUT.PUT_LINE('Saca Parametros');
        
        FOR Cur_Parameter IN
          (SELECT i.Record_ID,
            i.AD_User_ID,
            p.ParameterName,
            p.P_String,
            p.P_Number,
            p.P_Date,
            i.AD_Org_ID,
            i.AD_Client_ID
          FROM AD_PInstance i
          LEFT JOIN AD_PInstance_Para p
            ON i.AD_PInstance_ID=p.AD_PInstance_ID
          WHERE i.AD_PInstance_ID=p_PInstance_ID
          ORDER BY p.SeqNo)
        LOOP
          v_imp_total_procesar_id:=Cur_Parameter.Record_ID;
          v_User_ID:=Cur_Parameter.AD_User_ID;
          v_Org_ID:=Cur_Parameter.AD_Org_ID;
          v_Client_ID:=Cur_Parameter.AD_Client_ID;
          v_Parameter:=Cur_Parameter.ParameterName;
          v_Fecha:=Cur_Parameter.P_Date;
        END LOOP;
        
    
    select  cco_cuenta_costos_id,
            value,      
            name, 
            total, 
            procesado 
    into    v_cco_cuenta_costos_id,  
            v_value,  
            v_name, 
            v_total_gasto,
            v_procesado 
    from imp_total_procesar 
    where imp_total_procesar_id=v_imp_total_procesar_id;

    
    select sum(f.qtyinvoiced) 
    into v_total_cant_factura
    from cco_registra_costos c, 
         c_invoiceline f 
    where c.cco_cuenta_costos_id=v_cco_cuenta_costos_id 
      and f.c_invoice_id=c.c_invoice_id;
    
    select sum(c.valor) 
    into v_total_imp
    from cco_registra_costos c,
         c_invoice i
    where c.cco_cuenta_costos_id=v_cco_cuenta_costos_id 
      and i.c_invoice_id=c.c_invoice_id
      and c.em_imp_esfacturaimp='Y';
    
    select sum(c.valor) 
    into v_gasto_imp
    from cco_registra_costos c,
         c_invoice i
    where c.cco_cuenta_costos_id=v_cco_cuenta_costos_id 
      and i.c_invoice_id=c.c_invoice_id
      and c.em_imp_esfacturaimp='N';

    
    v_porcentaje_gasto:=round(v_gasto_imp/v_total_imp,5);

      
    FOR Cur_TodasFacturas IN
      (select * 
        from cco_registra_costos 
        where cco_cuenta_costos_id=v_cco_cuenta_costos_id 
        and em_imp_esfacturaimp='Y')
    LOOP
       
        
        FOR Cur_IndividualFacturas IN
            (select * 
              from c_invoiceline 
              where c_invoice_id=Cur_TodasFacturas.c_invoice_id)
        LOOP

        
        v_costo = Cur_IndividualFacturas.priceactual*(1+v_porcentaje_gasto);

        
    	select m_costing_id, 
               cost 
        into   v_m_costing_id,
               v_cost_costing 
        from   m_costing 
        where  m_product_id=Cur_IndividualFacturas.M_PRODUCT_ID 
          and  dateto=TO_DATE('31-12-9999', 'DD-MM-YYYY');

        
    	select sum (MOVEMENTQTY) 
        into v_stock 
        from M_transaction 
        where m_product_id=Cur_IndividualFacturas.M_PRODUCT_ID;

        
        DBMS_OUTPUT.PUT_LINE('Insert imp_gasto');
        DBMS_OUTPUT.PUT_LINE('Data ' || v_porcentaje_gasto);
        INSERT INTO imp_datos_gasto(
                    imp_datos_gasto_id,                     ad_client_id,                           ad_org_id,                          isactive, 
                    created,                                createdby,                              updated,                            updatedby, 
                    m_product_id,                           cco_cuenta_costos_id,                   porcentaje,                         gastoreal, 
                    gasto,                                  costogasto,                             costomedio)
            VALUES (Ad_Sequence_Nextno('im_datos_gasto'),   Cur_IndividualFacturas.AD_CLIENT_ID,    Cur_IndividualFacturas.AD_ORG_ID,   'Y',
                    now(),                         v_User_ID,                              now(),                     v_User_ID, 
                    Cur_IndividualFacturas.M_PRODUCT_ID,    v_cco_cuenta_costos_id,                 v_porcentaje_gasto,                 0,
                    0,                                      0,                                      v_costo);
            
        
        DBMS_OUTPUT.PUT_LINE('Insert m_costing');
        INSERT INTO M_COSTING(
                    m_costing_id,                       created,                                createdby,                          updated, 
                    updatedby,                          ad_client_id,                           ad_org_id,                          m_product_id, 
                    datefrom,                           dateto,                                 ismanual,                           m_inoutline_id, 
                    c_invoiceline_id,                   qty,                                    price,                              cumqty, 
                    costtype,                           ispermanent,                            "cost",                             m_productionline_id, 
                    isproduction,                       isactive)
            VALUES( Ad_Sequence_Nextno('M_Costing'),    now(),                         v_User_ID,                          now(),
                    v_User_ID,                          Cur_IndividualFacturas.AD_CLIENT_ID,    Cur_IndividualFacturas.AD_ORG_ID,   Cur_IndividualFacturas.M_PRODUCT_ID, 
                    date(v_Fecha),                      TO_DATE('31-12-9999', 'DD-MM-YYYY'),    'Y',                                NULL,
                    NULL,                               Cur_IndividualFacturas.qtyinvoiced,     v_costo,                            v_stock,
                    'AV',                               'N',                                    v_costo,                            NULL, 
                    'N',                                'Y');
           
        
        UPDATE M_COSTING
           SET DATETO = date(v_Fecha)
         WHERE m_costing_id=v_m_costing_id;
   
        END LOOP; 
        
    END LOOP; 
    

    
    UPDATE imp_total_procesar
       SET procesado='Y'
     WHERE imp_total_procesar_id=v_imp_total_procesar_id;

    
    v_Message:='@EjecucionCorrecta@';
    DBMS_OUTPUT.PUT_LINE('Updating PInstance - Finished - ' || v_Message) ;
    AD_UPDATE_PINSTANCE(p_PInstance_ID, v_User_ID, 'Y', v_Result, v_Message);
    RETURN;
        
    END;
    EXCEPTION
    WHEN OTHERS THEN
        v_ResultStr:= '@ERROR=' || SQLERRM;
        DBMS_OUTPUT.PUT_LINE(v_ResultStr) ;
        
        AD_UPDATE_PINSTANCE(p_PInstance_ID, NULL, 'N', 0, v_ResultStr);
        RETURN;
END IMP_PROCESA_IMPORTACION
]]></body>
    </function>
  </database>
