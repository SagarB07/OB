<?xml version="1.0"?>
  <database name="TRIGGER ATECFE_COPIA_FACTURA_TRG">
    <trigger name="ATECFE_COPIA_FACTURA_TRG" table="C_INVOICE" fires="before" insert="false" update="true" delete="false" foreach="row">
      <body><![CDATA[
v_c_invoice_id              VARCHAR(32);
v_ad_org_id                 VARCHAR(32);
v_c_doctype_id              VARCHAR(32);
v_c_doctypetarget_id        VARCHAR(32);
v_c_bp_group_id             VARCHAR(32);
v_c_bpartner_id             VARCHAR(32);
v_taxid                     VARCHAR(20);
v_ad_user_id                VARCHAR(32);
v_ad_role_id                VARCHAR(32);
v_c_location_id             VARCHAR(32);
v_c_bpartner_location_id    VARCHAR(32);
v_c_paymentterm_id          VARCHAR(32);
v_m_pricelist_id            VARCHAR(32);
v_fin_paymentmethod_id      VARCHAR(32);
v_m_product_category_id     VARCHAR(32);
v_c_taxcategory_id          VARCHAR(32);
v_c_tax_id                  VARCHAR(32);
v_m_product_id              VARCHAR(32);
v_ip_serv_consul            VARCHAR(200);
v_puerto_bdd                NUMBER; 
v_nombre_bdd                VARCHAR(255);
v_usuario_bdd               VARCHAR(255);
v_password_bdd              VARCHAR(255);
v_conn                      VARCHAR(255);
v_ad_client_id              VARCHAR(255);
v_em_atecfe_fac_elec        CHAR(1);
v_mensaje                   VARCHAR(255);
v_em_atecfe_cre_deb         NUMBER;
v_em_atecfe_doc_inv         VARCHAR(30); 
v_em_atecfe_fec_inv         DATE;
v_process_id                VARCHAR(32);
v_pinstance_id              VARCHAR(32);

cur_lineas                  RECORD;

BEGIN

IF UPDATING THEN 

    SELECT d.em_atecfe_fac_elec
          INTO v_em_atecfe_fac_elec
    FROM c_invoice i
    INNER JOIN c_doctype d ON (i.c_doctype_id = d.c_doctype_id)
    WHERE c_invoice_id = :OLD.c_invoice_id;

    IF (:NEW.em_atecfe_docstatus = 'AP' AND :OLD.em_atecfe_docstatus <> 'AP') THEN
                
        SELECT a.ip_serv_consul, a.puerto_bdd, a.nombre_bdd, a.usuario_bdd, a.password_bdd, a.ad_client_id, :OLD.ad_org_id, :OLD.c_doctype_id, :OLD.c_bpartner_id, :OLD.c_paymentterm_id, :OLD.m_pricelist_id, :OLD.fin_paymentmethod_id, :OLD.c_invoice_id, :OLD.c_doctypetarget_id
               INTO v_ip_serv_consul, v_puerto_bdd, v_nombre_bdd, v_usuario_bdd, v_password_bdd, v_ad_client_id, v_ad_org_id, v_c_doctype_id, v_c_bpartner_id, v_c_paymentterm_id, v_m_pricelist_id, v_fin_paymentmethod_id, v_c_invoice_id, v_c_doctypetarget_id
        FROM atecfe_conf_servidor a
        WHERE a.ad_client_id = :OLD.ad_client_id;

       
        SELECT b.c_bp_group_id, bl.c_location_id, bl.c_bpartner_location_id, b.taxid
                INTO v_c_bp_group_id, v_c_location_id, v_c_bpartner_location_id, v_taxid
        FROM c_bpartner b 
             LEFT JOIN c_bpartner_location bl ON (b.c_bpartner_id = bl.c_bpartner_id)
        WHERE b.c_bpartner_id = v_c_bpartner_id;

        v_conn := 'dbname='|| v_nombre_bdd ||' host='|| v_ip_serv_consul || ' user='|| v_usuario_bdd ||' password='|| v_password_bdd ||' port='|| v_puerto_bdd ||'';

        

        IF (NOT EXISTS(SELECT a.ad_client_id
                       FROM
                       dblink(v_conn, 'SELECT ad_client_id FROM ad_client') 
                       AS a(ad_client_id VARCHAR(32))
                       WHERE  a.ad_client_id = v_ad_client_id)) THEN

            perform dblink_exec (v_conn, (SELECT 'INSERT INTO ad_client VALUES ('''||coalesce(ad_client_id,'')||''','''
                                        ||coalesce(ad_org_id,'')||''','''|| 'Y'||''','''
                                        ||now()||''','''|| '100'||''','''
                                        ||now()||''','''|| '100'||''','''
                                        ||coalesce(value,'')||''','''||coalesce(name,'')||''','''
                                        ||coalesce(description,'')||''','''||'100'||''','''
                                        ||'100'||''','''||'100'||''','''||'100'||''','''||'100'||''','''||'es_EC'||''','''
                                        ||coalesce(ismultilingualdocument,'')||''','''||coalesce(issmtpauthorization,'')||''','''
                                        ||'100'||''','''||coalesce(acctdim_centrally_maintained,'')||''','''
                                        ||coalesce(project_acctdim_isenable,'')||''','''||coalesce(project_acctdim_header,'')||''','''||coalesce(project_acctdim_lines,'')||''','''
                                        ||coalesce(project_acctdim_breakdown,'')||''','''||coalesce(bpartner_acctdim_isenable,'')||''','''||coalesce(bpartner_acctdim_header,'')||''','''
                                        ||coalesce(bpartner_acctdim_lines,'')||''','''||coalesce(bpartner_acctdim_breakdown,'')||''','''||coalesce(product_acctdim_isenable,'')||''','''
                                        ||coalesce(product_acctdim_header,'')||''','''||coalesce(product_acctdim_lines,'')||''','''||coalesce(product_acctdim_breakdown,'')||''','''
                                        ||coalesce(costcenter_acctdim_header,'')||''','''||coalesce(costcenter_acctdim_lines,'')||''','''||coalesce(costcenter_acctdim_breakdown,'')||''','''
                                        ||coalesce(user1_acctdim_isenable,'')||''','''||coalesce(user1_acctdim_header,'')||''','''||coalesce(user1_acctdim_lines,'')||''','''
                                        ||coalesce(user1_acctdim_breakdown,'')||''','''||coalesce(user2_acctdim_isenable,'')||''','''||coalesce(user2_acctdim_header,'')||''','''
                                        ||coalesce(user2_acctdim_lines,'')||''','''||coalesce(user2_acctdim_breakdown,'')||''','''||coalesce(costcenter_acctdim_isenable,'')||''','''
                                        ||coalesce(org_acctdim_isenable,'')||''','''||coalesce(org_acctdim_header,'')||''','''||coalesce(org_acctdim_lines,'')||''','''
                                        ||coalesce(org_acctdim_breakdown,'')||''','''||coalesce(em_co_nro_estab,'')||''','''||coalesce(em_atecfe_contriespecial,'')||''','''
                                        ||coalesce(em_atecfe_tipoambiente,'')||''','''||coalesce(em_atecfe_numresolsri,'')||''','''||coalesce(em_atecfe_codinumerico,'')||''','''
                                        ||coalesce(em_atecfe_tipoemisi,'')||''','''||coalesce(em_atecfe_obligcontabi,'')||''');'
                                        FROM ad_client WHERE ad_client_id = v_ad_client_id));
        ELSE
            perform dblink_exec (v_conn, (SELECT 'UPDATE ad_client SET em_atecfe_contriespecial='''
                                        ||em_atecfe_contriespecial||''', em_atecfe_tipoambiente = '''
                                        ||em_atecfe_tipoambiente||''', em_atecfe_numresolsri = '''
                                        ||em_atecfe_numresolsri||''', em_atecfe_codinumerico = '''
                                        ||em_atecfe_codinumerico||''', em_atecfe_tipoemisi = '''
                                        ||em_atecfe_tipoemisi||''', em_atecfe_obligcontabi = '''
                                        ||em_atecfe_obligcontabi||''' WHERE ad_client_id = '''||v_ad_client_id||''';'  
                                        FROM ad_client WHERE ad_client_id = v_ad_client_id));
        END IF;
        
        IF (NOT EXISTS (SELECT a.ad_org_id
                        FROM dblink(v_conn,'SELECT ad_org_id FROM ad_org') 
                        AS a(ad_org_id VARCHAR(32))
                        WHERE a.ad_org_id = v_ad_org_id))THEN
            
            perform dblink_exec (v_conn, (SELECT 'INSERT INTO ad_org VALUES ('''||coalesce(ad_org_id,'')
                                        ||''','''||coalesce(ad_client_id,'')
                                        ||''','''||'Y'||''','''||now()
                                        ||''','''||'100'||''','''||now()
                                        ||''','''||'100'||''','''||coalesce(value,'')
                                        ||''','''||coalesce(name,'')||''','''||coalesce(description,'')
                                        ||''','''||coalesce(issummary,'')||''','''||coalesce(ad_orgtype_id,'1')
                                        ||''','''||'N'||''',null,'''||'N'
                                        ||''','''||coalesce(social_name,'')
                                        ||''','''||'100'||''',null,null,null);'
                                        FROM ad_org 
                                        WHERE ad_org_id = v_ad_org_id));
        END IF;

        IF(NOT EXISTS(SELECT a.ad_client_id
                       FROM
                       dblink(v_conn, 'SELECT ad_client_id FROM c_poc_configuration') 
                       AS a(ad_client_id VARCHAR(32))
                       WHERE  a.ad_client_id = v_ad_client_id)) THEN
            perform dblink_exec (v_conn, (SELECT 'INSERT INTO c_poc_configuration (c_poc_configuration_id, ad_client_id, ad_org_id, isactive, '
                                           ||'created, createdby, updated, updatedby, '
                                           ||'smtpserver, smtpserveraccount, smtpserverpassword, '
                                           ||'issmtpauthorization, smtpserversenderaddress, smtpconnectionsecurity, smtpport) VALUES ('''
                                           ||coalesce(pc.c_poc_configuration_id,'')||''','''
                                           ||coalesce(pc.ad_client_id,'')||''', '''||coalesce(ad_org_id,'')||''', '''||coalesce(pc.isactive,'N')||''','''
                                           ||now()||''','''||'100'||''','''||now()||''','''||'100'||''','''
                                           ||coalesce(pc.smtpserver,'')||''','''||coalesce(pc.smtpserveraccount,'')||''','''
                                           ||coalesce(pc.smtpserverpassword,'')||''','''||coalesce(pc.issmtpauthorization,'')||''','''
                                           ||coalesce(pc.smtpserversenderaddress,'')||''','''||coalesce(pc.smtpconnectionsecurity,'')||''','''||coalesce(pc.smtpport,0)||''');'
                                           FROM c_poc_configuration pc
                                           WHERE pc.ad_client_id = v_ad_client_id
                                           AND pc.isactive = 'Y'));
        ELSE
            perform dblink_exec (v_conn, (SELECT 'UPDATE c_poc_configuration SET smtpserver = '''
                                           ||coalesce(pc.smtpserver,'')||''', smtpserveraccount = '''||coalesce(pc.smtpserveraccount,'')
                                           ||''', smtpserverpassword = '''||coalesce(pc.smtpserverpassword,'')||''', issmtpauthorization = '''||coalesce(pc.issmtpauthorization,'')
                                           ||''', smtpserversenderaddress = '''||coalesce(pc.smtpserversenderaddress,'') 
                                           ||''', smtpconnectionsecurity = '''||coalesce(pc.smtpconnectionsecurity,'')||''' WHERE ad_client_id = '''||v_ad_client_id||''''
                                           FROM c_poc_configuration pc
                                           WHERE pc.ad_client_id = v_ad_client_id
                                           AND pc.isactive = 'Y'));
        END IF;

        IF(NOT EXISTS(SELECT a.c_doctype_id
                      FROM dblink(v_conn,'SELECT c_doctype_id FROM c_doctype') 
                      AS a(c_doctype_id VARCHAR(32))
                      WHERE  a.c_doctype_id = v_c_doctype_id))THEN
            
            perform dblink_exec (v_conn, (SELECT 'INSERT INTO c_doctype VALUES('''||coalesce(c_doctype_id,'')||''','''||coalesce(ad_client_id,'')||''','''|| '0'
                                            ||''','''||'Y'||''','''||now()||''','''||'100'
                                            ||''','''||now()||''','''||'100'|| ''','''||coalesce(name,'')
                                            ||''','''||coalesce(printname,'')||''','''','''||coalesce(docbasetype,'')||''','''
                                            ||coalesce(issotrx,'')||''',null,null,null,'''||coalesce(isdocnocontrolled,'')||''', null,'''
                                            ||'0'||''','''||coalesce(documentnote,'')||''','''
                                            ||coalesce(isdefault,'')||''',1,null,'''||coalesce(orgfiltered,'')||''',null,'''
                                            ||coalesce(isexpense,'')||''','''||coalesce(isreversal,'')||''','''||coalesce(isreturn,'')||''',null,'||coalesce(em_co_tp_comp_autorizador_sri,1)||');'
                                    FROM c_doctype 
                                    WHERE c_doctype_id = v_c_doctype_id));
        ELSE
            perform dblink_exec (v_conn, (SELECT 'UPDATE c_doctype SET em_co_tp_comp_autorizador_sri = '
                                        ||coalesce(em_co_tp_comp_autorizador_sri,1)||' WHERE c_doctype_id = '''||v_c_doctype_id||''';'
            FROM c_doctype 
            WHERE c_doctype_id = v_c_doctype_id)); 
        END IF;

        IF(NOT EXISTS(SELECT a.c_doctype_id
                      FROM dblink(v_conn,'SELECT c_doctype_id FROM c_doctype') 
                      AS a(c_doctype_id VARCHAR(32))
                      WHERE  a.c_doctype_id = v_c_doctypetarget_id))THEN
            
            perform dblink_exec (v_conn, (SELECT 'INSERT INTO c_doctype VALUES('''||coalesce(c_doctype_id,'')||''','''||coalesce(ad_client_id,'')||''','''|| '0'
                                            ||''','''||'Y'||''','''||now()||''','''||'100'
                                            ||''','''||now()||''','''||'100'|| ''','''||coalesce(name,'')
                                            ||''','''||coalesce(printname,'')||''','''','''||coalesce(docbasetype,'')||''','''
                                            ||coalesce(issotrx,'')||''',null,null,null,'''||coalesce(isdocnocontrolled,'')||''', null,'''
                                            ||'0'||''','''||coalesce(documentnote,'')||''','''
                                            ||coalesce(isdefault,'')||''',1,null,'''||coalesce(orgfiltered,'')||''',null,'''
                                            ||coalesce(isexpense,'')||''','''||coalesce(isreversal,'')||''','''||coalesce(isreturn,'')||''',null,'||coalesce(em_co_tp_comp_autorizador_sri,1)||');'
                                    FROM c_doctype 
                                    WHERE c_doctype_id = v_c_doctypetarget_id));
        ELSE
            perform dblink_exec (v_conn, (SELECT 'UPDATE c_doctype SET em_co_tp_comp_autorizador_sri = '
                                        ||coalesce(em_co_tp_comp_autorizador_sri,1)||' WHERE c_doctype_id = '''||v_c_doctypetarget_id||''';'
            FROM c_doctype 
            WHERE c_doctype_id = v_c_doctypetarget_id)); 
        END IF;

        IF(NOT EXISTS(SELECT b.c_bp_group_id
                        FROM
                        dblink(v_conn,'SELECT c_bp_group_id FROM c_bp_group') 
                        AS b(c_bp_group_id VARCHAR(32))
                        WHERE  b.c_bp_group_id = v_c_bp_group_id))THEN
            
            perform dblink_exec (v_conn, (SELECT 'INSERT INTO c_bp_group VALUES ( '''||coalesce(c_bp_group_id,'')||''','''
                                            ||coalesce(ad_client_id,'')||''','''||'0'||''','''
                                            ||'Y'||''','''||now()||''','''||'100'||''','''
                                            ||now()||''','''||'100'||''','''||coalesce(value,'')||''','''
                                            ||coalesce(name,'')||''','''','''||coalesce(isdefault,'')||''');'
                                            FROM c_bp_group 
                                            WHERE c_bp_group_id = v_c_bp_group_id));
        END IF;
        

        IF(NOT EXISTS (SELECT a.c_bpartner_id
                        FROM
                        dblink(v_conn,'SELECT c_bpartner_id FROM c_bpartner ') 
                        as a(c_bpartner_id VARCHAR(32))
                        WHERE  a.c_bpartner_id = v_c_bpartner_id))THEN
            
            perform dblink_exec (v_conn, (SELECT 'INSERT INTO c_bpartner(c_bpartner_id,ad_client_id,ad_org_id,isactive,'
                                            ||'created,	createdby, updated, updatedby,'
                                            ||'value, name, name2, description,'
                                            ||'issummary, c_bp_group_id, isonetime, isprospect,'
                                            ||'isvendor,  iscustomer,	isemployee,	issalesrep,'
                                            ||'taxid, istaxexempt, firstsale, acqusitioncost,'
                                            ||'potentiallifetimevalue, actuallifetimevalue, so_creditlimit, so_creditused,'
                                            ||'isdiscountprinted, socreditstatus, showpriceinorder, isworker,'
                                            ||'customer_blocking, vendor_blocking, so_payment_blocking,	po_payment_blocking,'
                                            ||'so_invoice_blocking, po_invoice_blocking, so_order_blocking, po_order_blocking,'
                                            ||'so_goods_blocking, po_goods_blocking) VALUES ( '''
                                            ||coalesce(c_bpartner_id,'')||''','''
                                            ||'0'||''','''||'0'||''','''||'Y'||''','''
                                            ||now()||''','''||'100'||''','''
                                            ||now()||''','''||'100'||''','''||coalesce(value,'')||''','''
                                            ||coalesce(replace(name,'''',''''''),'')||''','''||coalesce(replace(name2,'''',''''''),'')||''','''||coalesce(description,'')||''','''
                                            ||coalesce(issummary,'')||''','''||coalesce(c_bp_group_id,'')||''','''
                                            ||coalesce(isonetime,'')||''','''||coalesce(isprospect,'')||''','''
                                            ||coalesce(isvendor,'')||''','''||coalesce(iscustomer,'')||''','''
                                            ||coalesce(isemployee,'')||''','''||coalesce(issalesrep,'')||''','''
                                            ||coalesce(taxid,'')||''','''||coalesce(istaxexempt,'')||''',null,'''
                                            ||coalesce(acqusitioncost,0)||''','''||coalesce(potentiallifetimevalue,0)||''','''
                                            ||coalesce(actuallifetimevalue,0)||''','''||coalesce(so_creditlimit,0)||''','''
                                            ||coalesce(so_creditused,0)||''','''||coalesce(isdiscountprinted,'')||''','''
                                            ||coalesce(socreditstatus,'')||''','''||coalesce(showpriceinorder,'')||''','''
                                            ||coalesce(isworker,'')||''','''||coalesce(customer_blocking,'')||''','''
                                            ||coalesce(vendor_blocking,'')||''','''||coalesce(so_payment_blocking,'')||''','''
                                            ||coalesce(po_payment_blocking,'')||''','''||coalesce(so_invoice_blocking,'')||''','''
                                            ||coalesce(po_invoice_blocking,'')||''','''||coalesce(so_order_blocking,'')||''','''
                                            ||coalesce(po_order_blocking,'')||''','''||coalesce(so_goods_blocking,'')||''','''
                                            ||coalesce(po_goods_blocking,'')||''');'
                                            FROM c_bpartner
                                            WHERE c_bpartner_id = v_c_bpartner_id));
            END IF;

            IF(NOT EXISTS(SELECT a.username 
                            FROM
                            dblink(v_conn,'SELECT username FROM ad_user') 
                            AS a(username VARCHAR(32))
                            WHERE a.username = v_taxid))THEN
                            
                SELECT get_uuid() INTO v_ad_user_id;
                
                perform dblink_exec (v_conn, (SELECT 'INSERT INTO ad_user (ad_user_id, ad_client_id, ad_org_id, '
                                                ||'isactive, created, createdby, updated, updatedby, name, username, '
                                                ||'password, email, c_bpartner_id, processing, islocked, grant_portal_access, '
                                                ||'default_ad_language) values ('''
                                                ||v_ad_user_id||''',''0'',''0'',''Y'','''
                                                ||now()||''',''100'','''
                                                ||now()||''',''100'','''||replace(b.name,'''','''''')||''','''||b.taxid||''','''
                                                ||encode(digest(b.taxid,'sha1'),'base64')||''','''
                                                ||coalesce(u.email,'')||''','''||coalesce(b.c_bpartner_id,'')||''','''
                                                ||'N'||''','''||'N'||''','''||'N'||''',''es_EC'');'
                                                FROM c_bpartner b
                                                    LEFT JOIN ad_user u ON (b.c_bpartner_id = u.c_bpartner_id)
                                                WHERE b.c_bpartner_id = v_c_bpartner_id LIMIT 1));

                v_ad_role_id := NULL;

                SELECT a.ad_role_id
                    INTO v_ad_role_id
                FROM
                dblink(v_conn, 'SELECT ad_role_id, name FROM ad_role') 
                AS a(ad_role_id VARCHAR(32), name VARCHAR(60))
                WHERE upper(a.name) LIKE upper('%Consultar Facturas%');

                IF(v_ad_role_id IS NOT NULL)THEN
                    perform dblink_exec (v_conn, ('INSERT INTO ad_user_roles VALUES ('''
                                                    ||get_uuid()||''','''||v_ad_user_id||''','''
                                                    ||v_ad_role_id||''',''0'',''0'',''Y'','''
                                                    ||now()||''',''100'','''||now()||''',''100'',''N'');'));
            END IF;
        ELSE
            SELECT a.ad_user_id 
                    INTO v_ad_user_id
            FROM
                dblink(v_conn,'SELECT ad_user_id, username FROM ad_user') 
                AS a(ad_user_id VARCHAR(32), username VARCHAR(60))
            WHERE a.username = v_taxid;
        END IF;
        
        IF(NOT EXISTS(SELECT a.c_location_id
                        FROM
                        dblink(v_conn,'SELECT c_location_id FROM c_location') 
                        as a(c_location_id VARCHAR(32))
                        WHERE  a.c_location_id = v_c_location_id))THEN
            
            perform dblink_exec (v_conn, (SELECT 'INSERT INTO c_location VALUES ( '''||c_location_id||''','''||coalesce(ad_client_id,'')||''','''
                                            ||'0'||''','''||'Y'||''','''||now()||''','''||'100'||''','''
                                            ||now()||''','''||'100'||''','''||coalesce(address1,'')||''','''
                                            ||coalesce(address2,'')||''','''||coalesce(city,'')||''','''
                                            ||coalesce(postal,'')||''','''||coalesce(postal_add,'')||''',171,null,null,'''
                                            ||coalesce(regionname,'')||''','''||coalesce(em_co_parroquia,'')||''','''
                                            ||coalesce(em_co_barrio,'')||''');'
                                            FROM c_location
                                            WHERE c_location_id = v_c_location_id));
        END IF;
        
        IF(not exists (SELECT a.c_bpartner_location_id
                        FROM
                        dblink(v_conn,'SELECT c_bpartner_location_id FROM c_bpartner_location') 
                        AS a(c_bpartner_location_id VARCHAR(32))
                        WHERE  a.c_bpartner_location_id = v_c_bpartner_location_id))THEN
             
            perform dblink_exec (v_conn, (SELECT 'INSERT INTO c_bpartner_location VALUES ('''
                                            ||coalesce(c_bpartner_location_id)||''','''||coalesce(ad_client_id,'')||''',''0'',''Y'','''
                                            ||now()||''','''||'100'||''','''||now()||''','''||'100'||''','''
                                            ||coalesce(name,'')||''','''||coalesce(isbillto,'')||''','''
                                            ||coalesce(isshipto,'')||''','''||coalesce(ispayfrom,'')||''','''
                                            ||coalesce(isremitto,'')||''','''||coalesce(phone,'')||''','''
                                            ||coalesce(phone2,'')||''','''||coalesce(fax,'')||''',null,'''
                                            ||c_bpartner_id||''','''||c_location_id||''','''
                                            ||coalesce(istaxlocation,'')||''','''
                                            ||coalesce(upc,'')||''','''||coalesce(em_no_num_dir,'')||''');'
                                            FROM c_bpartner_location
                                            WHERE c_bpartner_location_id = v_c_bpartner_location_id));
        END IF;
        
        IF(NOT EXISTS(SELECT a.c_paymentterm_id
                        FROM
                        dblink(v_conn,'SELECT c_paymentterm_id FROM c_paymentterm') 
                        AS a(c_paymentterm_id VARCHAR(32))
                        WHERE  a.c_paymentterm_id = v_c_paymentterm_id))THEN
            
            perform dblink_exec (v_conn, (SELECT 'INSERT INTO c_paymentterm(c_paymentterm_id,	ad_client_id, ad_org_id, isactive, created,'
                                            ||'createdby, updated, updatedby, name, description, documentnote, isduefixed,'
                                            ||'netdays, fixmonthday, fixmonthoffset, isnextbusinessday, isdefault,'
                                            ||'value, netday, isvalid, fixmonthday2, fixmonthday3) VALUES ( '''
                                            ||coalesce(c_paymentterm_id,'')||''','''
                                            ||coalesce(ad_client_id,'')||''','''
                                            ||'0'||''','''||'Y'||''','''||now()||''','''||'100'||''','''
                                            ||now()||''','''||'100'||''','''
                                            ||coalesce(name,'')||''','''||coalesce(description,'')||''','''
                                            ||coalesce(documentnote,'')||''','''||coalesce(isduefixed,'')||''','''
                                            ||coalesce(netdays,0)||''','''||coalesce(fixmonthday,0)||''','''
                                            ||coalesce(fixmonthoffset,0)||''','''||coalesce(isnextbusinessday,'')||''','''
                                            ||coalesce(isdefault,'')||''','''||coalesce(value,'')||''','''||coalesce(netday,'')||''','''
                                            ||isvalid||''','''
                                            ||coalesce(fixmonthday2,0)
                                            ||''','''||coalesce(fixmonthday3,0)||''');'
                                    FROM c_paymentterm
                                    WHERE c_paymentterm_id = v_c_paymentterm_id));
        END IF;
        
        IF(NOT EXISTS(SELECT a.m_pricelist_id
                        FROM
                        dblink(v_conn,'SELECT m_pricelist_id FROM m_pricelist') 
                        AS a(m_pricelist_id VARCHAR(32))
                        WHERE  a.m_pricelist_id = v_m_pricelist_id))THEN
            
            perform dblink_exec (v_conn, (SELECT 'INSERT INTO m_pricelist(m_pricelist_id,	ad_client_id, ad_org_id, isactive,'
                                            || 'created, createdby,	updated, updatedby, name, description,'
                                            || 'basepricelist_id, istaxincluded, issopricelist, isdefault, c_currency_id, enforcepricelimit,'
                                            || 'costbased) VALUES ('''||coalesce(m_pricelist_id,'')||''','''||coalesce(ad_client_id,'')||''','''||'0'||''','''
                                            ||'Y'||''','''||now()||''','''||'100'||''','''||now()||''','''
                                            ||'100'||''','''||name||''','''||coalesce(description,'')||''',null,'''
                                            ||coalesce(istaxincluded,'')||''','''||coalesce(issopricelist,'')||''','''||coalesce(isdefault,'')||''','''
                                            ||coalesce(c_currency_id,'')||''','''||coalesce(enforcepricelimit,'')||''','''||coalesce(costbased,'')||''');'
                                            FROM m_pricelist
                                            WHERE m_pricelist_id = v_m_pricelist_id));
        END IF;
        
        IF(NOT EXISTS(SELECT a.fin_paymentmethod_id
                        FROM
                        dblink(v_conn,'SELECT fin_paymentmethod_id FROM fin_paymentmethod') 
                        as a(fin_paymentmethod_id VARCHAR(32))
                        WHERE  a.fin_paymentmethod_id = v_fin_paymentmethod_id))THEN
            
            perform dblink_exec (v_conn, (SELECT 'INSERT INTO fin_paymentmethod(fin_paymentmethod_id, ad_client_id,  ad_org_id, created,'
                                            ||'createdby, updated, updatedby, isactive,'
                                            ||'name,  description, automatic_receipt,  automatic_payment,'
                                            ||'automatic_deposit,  automatic_withdrawn,  payin_allow, payout_allow,'
                                            ||'payin_execution_type,  payout_execution_type,  payin_execution_process_id, payout_execution_process_id,'
                                            ||'payin_deferred, payout_deferred,  uponreceiptuse, upondeposituse,'
                                            ||'inuponclearinguse,  uponpaymentuse, uponwithdrawaluse,  outuponclearinguse,'
                                            ||'payin_ismulticurrency,  payout_ismulticurrency,  em_ats_codigo)VALUES ('''
                                            ||coalesce(fin_paymentmethod_id,'')||''', '''
                                            ||coalesce(ad_client_id,'')||''','''
                                            ||'0'||''','''||now()||''','''
                                            ||'100'||''','''||now()||''','''
                                            ||'100'||''','''||'Y'||''','''
                                            ||coalesce(name,'')||''','''||coalesce(description,'')||''','''
                                            ||coalesce(automatic_receipt,'')||''','''||coalesce(automatic_payment,'')||''','''
                                            ||coalesce(automatic_deposit,'')||''','''||coalesce(automatic_withdrawn,'')||''','''
                                            ||coalesce(payin_allow,'')||''','''||coalesce(payout_allow,'')||''','''
                                            ||coalesce(payin_execution_type,'')||''','''||coalesce(payout_execution_type,'')||''',null,null,'''
                                            ||coalesce(payin_deferred,'')||''','''||coalesce(payout_deferred,'')||''','''
                                            ||coalesce(uponreceiptuse,'')||''','''||coalesce(upondeposituse,'')||''','''
                                            ||coalesce(inuponclearinguse,'')||''','''||coalesce(uponpaymentuse,'')||''','''
                                            ||coalesce(uponwithdrawaluse,'')||''','''||coalesce(outuponclearinguse,'')||''','''
                                            ||coalesce(payin_ismulticurrency,'')||''','''||coalesce(payout_ismulticurrency,'')||''','''||coalesce(em_ats_codigo,'')||''');'
                                    FROM fin_paymentmethod
                                    WHERE fin_paymentmethod_id = v_fin_paymentmethod_id));
        END IF;
        
        IF(NOT EXISTS(SELECT a.c_invoice_id
                        FROM
                        dblink(v_conn,'SELECT c_invoice_id FROM c_invoice') 
                        as a(c_invoice_id VARCHAR(32))
                        WHERE  a.c_invoice_id = v_c_invoice_id))THEN



            perform dblink_exec (v_conn, (SELECT 'INSERT INTO c_invoice(c_invoice_id, ad_client_id, ad_org_id, isactive,'
                                            ||'created, createdby, updated, updatedby,'
                                            ||'issotrx, documentno, docstatus, docaction,'
                                            ||'processing, processed, posted, c_doctype_id,'
                                            ||'c_doctypetarget_id, c_order_id, description, isprinted,'
                                            ||'salesrep_id, dateinvoiced, dateprinted, dateacct,'
                                            ||'c_bpartner_id, c_bpartner_location_id, poreference, isdiscountprinted,'
                                            ||'dateordered, c_currency_id, paymentrule, c_paymentterm_id,'
                                            ||'c_charge_id, chargeamt, totallines, grandtotal,'
                                            ||'m_pricelist_id, istaxincluded, c_campaign_id, c_project_id,'
                                            ||'c_activity_id, createfrom, generateto, ad_user_id,'
                                            ||'copyfrom, isselfservice, ad_orgtrx_id, user1_id,'
                                            ||'user2_id, withholdingamount, taxdate, c_withholding_id,'
                                            ||'ispaid, totalpaid, outstandingamt, daystilldue,'
                                            ||'dueamt, lastcalculatedondate, updatepaymentmonitor, fin_paymentmethod_id,'
                                            ||'fin_payment_priority_id, finalsettlement, daysoutstanding, percentageoverdue,'
                                            ||'c_costcenter_id, calculate_promotions, a_asset_id, em_co_nro_aut_sri,'
                                            ||'em_co_vencimiento_aut_sri, em_co_nro_estab, em_co_punto_emision, em_co_codsustento,'
                                            ||'em_co_rise, em_ats_totalexento, em_ats_totalbase0,'
                                            ||'em_ats_totalbase12, em_ats_totaliva, em_ats_totalice, em_atecfe_docstatus,'
                                            ||'em_atecfe_docaction, em_atecfe_menobserror_sri, em_atecfe_codigo_acc, em_atecfe_documento_xml,'
                                            ||'em_atimp_importacion_id, em_aprm_addpayment, em_aprm_processinvoice, em_atecfe_fecha_autori, em_atecfe_email_clie, em_atecfe_ad_client) VALUES ('''
                                            ||coalesce(c_invoice_id,'')||''','''||coalesce(ad_client_id,'')||''','''||coalesce(ad_org_id,'')||''','''||'Y'||''','''
                                            ||now()||''','''||'100'||''','''||now()||''','''||'100'||''','''
                                            ||coalesce(issotrx,'')||''','''||coalesce(documentno,'')||''','''||coalesce(docstatus,'')||''','''
                                            ||coalesce(docaction,'')||''','''||coalesce(processing,'')||''','''
                                            ||'N'||''','''||'N'||''','''||coalesce(c_doctype_id,'')||''','''
                                            ||coalesce(c_doctypetarget_id,'')||''', null,'''||coalesce(description,'')||''','''
                                            ||coalesce(isprinted,'')||''',null,'''||dateinvoiced||''',null,'''
                                            ||dateacct||''','''||coalesce(c_bpartner_id,'')||''','''||coalesce(c_bpartner_location_id,'')||''',null,'''
                                            ||coalesce(isdiscountprinted,'')||''',null,'''||'100'||''','''||coalesce(paymentrule,'')||''','''
                                            ||coalesce(c_paymentterm_id,'')||''',null,'''||coalesce(0,0)||''','''
                                            ||coalesce(0,0)||''','''||coalesce(0,0)||''','''
                                            ||coalesce(m_pricelist_id,'')||''', ''N'',null, null, null,'''||coalesce(createfrom,'N')||''','''
                                            ||coalesce(generateto,'N')||''','''||replace(v_ad_user_id,'''','''''')||''','''
                                            ||coalesce(copyfrom,'')||''','''||coalesce(isselfservice,'')||''',null, null,null, null,null, null,'''
                                            ||coalesce(ispaid,'')||''','''||coalesce(0,0)||''','''||coalesce(0,0)||''','''||coalesce(0,0)||''','''
                                            ||coalesce(0,0)||''', null,'''||coalesce(updatepaymentmonitor,'')||''','''
                                            ||coalesce(fin_paymentmethod_id,'')||''',null, null,null, null,null,'''
                                            ||'N'||''',null,'''||coalesce(:NEW.em_co_nro_aut_sri,'')||''','''
                                            ||coalesce(:NEW.em_co_vencimiento_aut_sri,'31-12-9999')||''','''||coalesce(replace(em_co_nro_estab,'''',''''''),'')||''','''
                                            ||coalesce(replace(em_co_punto_emision,'''',''''''),'')||''', null,'''||coalesce(replace(em_co_rise,'''',''''''),'')||''',null, null,null, null,null,'''
                                            ||coalesce(replace(:NEW.em_atecfe_docstatus,'''',''''''),'')||''','''||coalesce(replace(:NEW.em_atecfe_docaction,'''',''''''),'')||''','''||coalesce(replace(:NEW.em_atecfe_menobserror_sri,'''',''''''),'')||''','''
                                            
                                            ||coalesce(replace(:NEW.em_atecfe_codigo_acc,'''',''''''),'')||''','''||coalesce(convert_to(replace(convert_from(:NEW.em_atecfe_documento_xml, 'UTF8'),'''',''''''), 'UTF8'),'')||''',null,'''||coalesce(replace(em_aprm_addpayment,'''',''''''),'')||''','''
                                            ||coalesce(replace(em_aprm_processinvoice,'''',''''''),'')||''','''||replace(:NEW.em_atecfe_fecha_autori,'''','''''')||''','''
                                            ||coalesce((SELECT array_to_string(array_agg(replace(u.email,'''','''''')), ';') FROM ad_user as u WHERE u.c_bpartner_id = i.c_bpartner_id AND u.em_atecfe_check_email = 'Y'),'')||''','''
                                            ||ad_client_id||''');'
                                            FROM c_invoice as i
                                            WHERE i.c_invoice_id = v_c_invoice_id));
        ELSE
            perform dblink_exec (v_conn, ('UPDATE c_invoice SET '
                                            ||'em_atecfe_documento_xml = '''||:NEW.em_atecfe_documento_xml||''', '
                                            ||'em_atecfe_docstatus = '''||:NEW.em_atecfe_docstatus||''', '
                                            ||'em_atecfe_docaction = '''||:NEW.em_atecfe_docaction||''', '
                                            ||'em_atecfe_codigo_acc = '''||:NEW.em_atecfe_codigo_acc||''', '
                                            ||'em_atecfe_menobserror_sri = '''||replace(:NEW.em_atecfe_menobserror_sri,'''','''''')||''', '
                                            ||'em_atecfe_fecha_autori = '''||:NEW.em_atecfe_fecha_autori||''', '
                                            ||'em_co_nro_aut_sri = '''||:NEW.em_co_nro_aut_sri||''', '
                                            ||'em_co_vencimiento_aut_sri = '''||:NEW.em_co_vencimiento_aut_sri||''', '
                                            ||'processed = ''N'', posted = ''N'', ispaid = ''N'''
                                            ||' WHERE c_invoice_id = '''||v_c_invoice_id||''';'));
        END IF;

        FOR cur_lineas IN (
            SELECT c_invoiceline_id from c_invoiceline where c_invoice_id = v_c_invoice_id
        ) LOOP

            SELECT p.m_product_category_id, t.c_taxcategory_id, il.c_tax_id, il.m_product_id
                    INTO v_m_product_category_id, v_c_taxcategory_id, v_c_tax_id, v_m_product_id
            FROM c_invoiceline il 
                 JOIN m_product p ON (il.m_product_id = p.m_product_id)
                 LEFT JOIN c_tax t ON (il.c_tax_id = t.c_tax_id)
            WHERE il.c_invoiceline_id = cur_lineas.c_invoiceline_id;

            IF(NOT EXISTS(SELECT a.m_product_category_id 
                            FROM
                            dblink(v_conn,'SELECT m_product_category_id FROM m_product_category') 
                            AS a(m_product_category_id VARCHAR(32))
                            WHERE  a.m_product_category_id = v_m_product_category_id))THEN

                perform dblink_exec (v_conn, (SELECT 'INSERT INTO m_product_category(m_product_category_id,ad_client_id, ad_org_id,isactive,'
                                                ||'created,createdby,updated,updatedby,'
                                                ||'value,name, description,isdefault,'
                                                ||'plannedmargin,a_asset_group_id,ad_image_id,issummary) VALUES ('''
                                                ||coalesce(m_product_category_id,'')||''', '''
                                                ||coalesce(ad_client_id,'')||''',''0'',''Y'','''||now()||''',''100'','''
                                                ||now()||''',''100'','''||coalesce(value,'')||''','''||coalesce(replace(name,'''',''''''),'')||''','''
                                                ||coalesce(description,'')||''','''||coalesce(isdefault,'')||''','''
                                                ||coalesce(plannedmargin,0)||''',null,null,'''||coalesce(issummary,'')||''');'
                                                FROM m_product_category
                                                WHERE m_product_category_id = v_m_product_category_id));
            END IF;
            
            IF(NOT EXISTS(SELECT a.c_taxcategory_id 
                            FROM
                            dblink(v_conn,'SELECT c_taxcategory_id FROM c_taxcategory') 
                            AS a(c_taxcategory_id VARCHAR(32))
                            WHERE  a.c_taxcategory_id = v_c_taxcategory_id))THEN
                
                perform dblink_exec (v_conn, (SELECT 'INSERT INTO c_taxcategory( c_taxcategory_id, ad_client_id, ad_org_id, isactive,'
                                                ||'created, createdby, updated, updatedby,'
                                                ||'name, description, isdefault, em_co_es_ice, em_co_tp_base_imponible, em_atecfe_codtax) VALUES ('''
                                                ||coalesce(c_taxcategory_id,'')||''','''
                                                ||coalesce(ad_client_id,'')||''',''0'', ''Y'','''
                                                ||now()||''',''100'','''
                                                ||now()||''',''100'','''
                                                ||coalesce(name,'')||''', '''||coalesce(description,'')||''','''
                                                ||coalesce(isdefault,'')||''', '''||coalesce(em_co_es_ice,'')
                                                ||''','''||coalesce(em_co_tp_base_imponible,'')||''', '''
                                                ||coalesce(em_atecfe_codtax,'')||''');'
                                                FROM c_taxcategory
                                                WHERE c_taxcategory_id = v_c_taxcategory_id));
            END IF;

            IF(NOT EXISTS(SELECT a.c_tax_id 
                            FROM
                            dblink(v_conn,'SELECT c_tax_id FROM c_tax') 
                            AS a(c_tax_id VARCHAR(32))
                            WHERE  a.c_tax_id = v_c_tax_id))THEN
                
                perform dblink_exec (v_conn, (SELECT 'INSERT INTO c_tax( c_tax_id,ad_client_id, ad_org_id,isactive,'
                                                ||'created,createdby,updated,name,'
                                                ||'updatedby, description,validfrom,issummary,'
                                                ||'rate,c_taxcategory_id,isdefault,istaxexempt,'
                                                ||'sopotype,cascade,line,iswithholdingtax,'
                                                ||'isnotaxable,istaxundeductable,istaxdeductable,isnovat,'
                                                ||'baseamount,doctaxamount,em_atecfe_tartax) VALUES ('''
                                                ||coalesce(c_tax_id,'')||''','''||coalesce(ad_client_id,'')||''',''0'',''Y'','''
                                                ||now()||''',''100'','''
                                                ||now()||''','''||name||''',''100'','''
                                                ||coalesce(description,'')||''','''
                                                ||validfrom||''','''||coalesce(issummary,'')||''','''
                                                ||coalesce(rate,0)||''','''||coalesce(c_taxcategory_id,'')||''','''
                                                ||coalesce(isdefault,'')||''','''||coalesce(istaxexempt,'')||''','''
                                                ||coalesce(sopotype)||''','''||coalesce(cascade,'')||''','''
                                                ||coalesce(line,0)||''','''||coalesce(iswithholdingtax,'')||''','''
                                                ||coalesce(isnotaxable,'')||''','''||coalesce(istaxundeductable,'')||''','''
                                                ||coalesce(istaxdeductable,'')||''','''||coalesce(isnovat,'')||''','''
                                                ||coalesce(baseamount,'')||''','''||coalesce(doctaxamount,'')||''','''||coalesce(em_atecfe_tartax,'')||''');'
                                                FROM c_tax
                                                WHERE c_tax_id = v_c_tax_id));
            END IF;

            IF(NOT EXISTS(SELECT a.m_product_id 
                            FROM
                            dblink(v_conn,'SELECT m_product_id FROM m_product') 
                            AS a(m_product_id VARCHAR(32))
                            WHERE  a.m_product_id = v_m_product_id))THEN
                
                perform dblink_exec (v_conn, (SELECT 'INSERT INTO m_product(m_product_id,ad_client_id, ad_org_id,isactive,'
                                                ||'created,createdby,updated,updatedby,'
                                                ||'value,name,c_uom_id,salesrep_id,issummary,isstocked,'
                                                ||'ispurchased,issold,isbom,isinvoiceprintdetails,'
                                                ||'ispicklistprintdetails,isverified,m_product_category_id, c_taxcategory_id,'
                                                ||'discontinued,processing,producttype,ispriceprinted,enforce_attribute,calculated,'
                                                ||'production,qtytype,isquantityvariable,isdeferredrevenue,isdeferredexpense,bookusingpoprice) VALUES ('''
                                                ||coalesce(m_product_id,'')||''','''||coalesce(ad_client_id,'')||''',''0'',''Y'','''
                                                ||now()||''',''100'','''||now()||''',''100'','''
                                                ||coalesce(value,'')||''','''||coalesce(name,'')||''',''100'',''100'','''
                                                ||coalesce(issummary,'')||''','''||coalesce(isstocked,'')||''','''
                                                ||coalesce(ispurchased,'')||''','''||coalesce(issold,'')||''','''
                                                ||coalesce(isbom,'')||''','''||coalesce(isinvoiceprintdetails,'')||''','''
                                                ||coalesce(ispicklistprintdetails,'')||''','''||coalesce(isverified,'')||''','''
                                                ||coalesce(m_product_category_id,'')||''','''||coalesce(c_taxcategory_id,'')||''','''
                                                ||coalesce(discontinued,'')||''','''||coalesce(processing,'')||''','''
                                                ||coalesce(producttype,'')||''','''||coalesce(ispriceprinted,'')||''','''
                                                ||coalesce(enforce_attribute,'')||''','''||coalesce(calculated,'')||''','''
                                                ||coalesce(production,'')||''','''||coalesce(qtytype,'')||''','''
                                                ||coalesce(isquantityvariable,'')||''','''||coalesce(isdeferredrevenue,'')||''','''
                                                ||coalesce(isdeferredexpense,'')||''','''||coalesce(bookusingpoprice,'')||''');'
                                                FROM m_product
                                                WHERE m_product_id = v_m_product_id));
            END IF;

            IF(NOT EXISTS(SELECT a.c_invoiceline_id 
                            FROM
                            dblink(v_conn,'SELECT c_invoiceline_id FROM c_invoiceline') 
                            AS a(c_invoiceline_id VARCHAR(32))
                            WHERE a.c_invoiceline_id = cur_lineas.c_invoiceline_id))THEN

                perform dblink_exec (v_conn, (SELECT 'INSERT INTO c_invoiceline(c_invoiceline_id,ad_client_id, ad_org_id,isactive,'
                                                ||'created,createdby,updated,updatedby,'
                                                ||'c_invoice_id,line,financial_invoice_line,m_product_id,'
                                                ||'qtyinvoiced,pricelist,priceactual,pricelimit,'
                                                ||'linenetamt,chargeamt,c_uom_id,c_tax_id,'
                                                ||'taxamt,isdescription,pricestd,'
                                                ||'iseditlinenetamt,taxbaseamt,line_gross_amount,gross_unit_price,'
                                                ||'grosspricestd,grosspricelist,isdeferred,explode) VALUES ('''
						||coalesce(c_invoiceline_id,'')||''','''
                                                ||coalesce(ad_client_id,'')||''','''||coalesce(ad_org_id,'')||''',''Y'','''||now()||''',''100'','''
                                                ||now()||''',''100'','''||coalesce(c_invoice_id,'')||''','''||coalesce(line,0)||''','''
                                                ||coalesce(financial_invoice_line,'')||''','''||coalesce(m_product_id,'')||''','''
                                                ||coalesce(qtyinvoiced,0)||''','''||coalesce(pricelist,0)||''','''||coalesce(priceactual,0)||''','''
                                                ||coalesce(pricelimit,0)||''','''||coalesce(linenetamt,0)||''','''||'10'||''',''100'','''
                                                ||coalesce(c_tax_id,'')||''','''||coalesce(taxamt,0)||''','''||coalesce(isdescription,'')||''','''
                                                ||coalesce(pricestd,0)||''','''
                                                ||coalesce(iseditlinenetamt,'')||''','''
                                                ||coalesce((taxbaseamt),0)||''','''
                                                ||coalesce(line_gross_amount,0)||''','''
                                                ||coalesce(gross_unit_price,0)||''','''
                                                ||coalesce(grosspricestd,0)||''','''
                                                ||coalesce(grosspricelist,0)||''','''||coalesce(isdeferred,'')||''','''||coalesce(explode,'')||''');'
                                                FROM c_invoiceline
                                                WHERE c_invoiceline_id = cur_lineas.c_invoiceline_id));
            END IF;

        END LOOP;

        IF((SELECT coalesce(dt.em_co_tp_comp_autorizador_sri,1)
            FROM c_invoice i
                INNER JOIN c_doctype dt ON (dt.c_doctype_id = i.c_doctypetarget_id)
            WHERE i.c_invoice_id = v_c_invoice_id) = 4 OR (SELECT coalesce(dt.em_co_tp_comp_autorizador_sri,1)
            FROM c_invoice i
                INNER JOIN c_doctype dt ON (dt.c_doctype_id = i.c_doctypetarget_id)
            WHERE i.c_invoice_id = v_c_invoice_id) = 5)THEN

            SELECT coalesce(dt2.em_co_tp_comp_autorizador_sri,1),  coalesce(i.documentno,''), i.dateinvoiced                    
                INTO v_em_atecfe_cre_deb, v_em_atecfe_doc_inv, v_em_atecfe_fec_inv
            FROM c_invoice i
                INNER JOIN c_invoice i2 ON (i.em_atecfe_c_invoice_id = i2.c_invoice_id)
                INNER JOIN c_doctype dt2 ON (dt2.c_doctype_id = i2.c_doctypetarget_id)
            WHERE i.c_invoice_id = v_c_invoice_id;

            perform dblink_exec (v_conn, ('UPDATE c_invoice SET processed = ''Y'', posted = ''Y'', ispaid = ''Y'', em_atecfe_cre_deb = '||v_em_atecfe_cre_deb||', em_atecfe_doc_inv = '''||v_em_atecfe_doc_inv||''', em_atecfe_fec_inv = '''||v_em_atecfe_fec_inv||''' WHERE c_invoice_id = '''||v_c_invoice_id||''';'));
        ELSE
            perform dblink_exec (v_conn, ('UPDATE c_invoice SET processed = ''Y'', posted = ''Y'', ispaid = ''Y'' WHERE c_invoice_id = '''||v_c_invoice_id||''';'));
        END IF;

    END IF;

    RETURN NEW; 

END IF;

IF DELETING THEN RETURN NEW; END IF; 

END ATECFE_COPIA_FACTURA_TRG
]]></body>
    </trigger>
  </database>
