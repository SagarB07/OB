<?xml version="1.0"?>
  <database name="TRIGGER NE_VACACION_VAL_TRG">
    <trigger name="NE_VACACION_VAL_TRG" table="NO_VACACION" fires="before" insert="true" update="true" delete="false" foreach="row">
      <body><![CDATA[

	v_days NUMBER;
	v_linea NUMBER;

	v_fecha_inicio timestamp without time zone;
	v_fecha_fin timestamp without time zone;
BEGIN
	select fecha_inicio, fecha_fin
	into v_fecha_inicio, v_fecha_fin
	from no_contrato_empleado
	where no_contrato_empleado_id = :new.no_contrato_empleado_id;

	if date(:new.em_ne_fecha_inicio) < date(v_fecha_inicio) then
		raise '%', '@NE_FECHA_VAC_VAL@';
	end if;

	if date(:new.em_ne_fecha_fin) > date(v_fecha_fin) then
		raise '%', '@NE_FECHA_VAC_VAL@';
	end if;
	
	if date(:new.em_ne_fecha_fin) <= date(:new.em_ne_fecha_inicio) then
		raise '%', '@NE_NO_VACACION_FECHA_VAL@';
	else
		select max(em_ne_linea) 
		into v_linea
		from no_vacacion;
		
		:new.em_ne_linea := v_linea + 10;

		v_days := DATE_PART('day', :new.em_ne_fecha_fin::timestamp - :new.em_ne_fecha_inicio::timestamp);
		:new.em_ne_total_dias=to_number(v_days);
	end if;
	return new; 

END NE_VACACION_VAL_TRG
]]></body>
    </trigger>
  </database>
