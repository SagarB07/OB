<?xml version="1.0"?>
  <database name="FUNCTION ASV_GUIA_DESPACHO_LDM">
    <function name="ASV_GUIA_DESPACHO_LDM" type="NULL">
      <parameter name="v_m_production_id" type="VARCHAR" mode="in">
        <default/>
      </parameter>
      <body><![CDATA[v_ad_client_id character varying(32);
	v_ad_org_id character varying(32);
	v_createdby character varying(32);
	v_updatedby character varying(32);
	v_c_bpartner_id character varying(32);
	v_c_bpartner_location_id character varying(32);
	v_m_warehouse_id character varying(32):='';
	v_documentno character varying(30);
	v_m_inout_id character varying(32);
	
	v_cursor RECORD;
	v_line NUMBER(10,0) := 0;
	v_c_uom_id character varying(32);
	v_m_locator_id character varying(32);
	v_bnd character(1) := 'N';
	v_movementqty NUMBER;
	v_m_productionplan_id character varying(32);
	v_qty NUMBER;
	
BEGIN
	select ad_client_id, ad_org_id, createdby, 
		updatedby
	into v_ad_client_id, v_ad_org_id, v_createdby,
		v_updatedby
	from m_production 
	where m_production_id = v_m_production_id;
	
	
	select c_bpartner_id 
	into v_c_bpartner_id 
	from c_bpartner 
	where name = 'ASERLACO S.A.';

	select c_bpartner_location_id
	into v_c_bpartner_location_id
	from c_bpartner_location
	where c_bpartner_id = v_c_bpartner_id;

	FOR v_cursor IN (
		select pl.m_product_id, l.m_locator_id, w.m_warehouse_id, pl.movementqty as qty, pr.name
		from m_production p, m_productionplan pp, m_productionline pl, 
			m_locator l, m_product pr, m_storage_detail sd, 
			m_warehouse w
		where p.m_production_id = pp.m_production_id
		and pp.m_productionplan_id = pl.m_productionplan_id
		and pl.m_locator_id = l.m_locator_id
		and p.m_production_id = v_m_production_id
		and pl.movementqty < 0
		and pr.m_product_id = pl.m_product_id
		and pr.m_product_id = sd.m_product_id
		and sd.m_locator_id = l.m_locator_id
		and l.m_warehouse_id = w.m_warehouse_id
		union 
		select il.m_product_id, l.m_locator_id, w.m_warehouse_id, il.qtyinvoiced as qty, p.name
		from c_invoice i, c_invoiceline il, m_product p, m_storage_detail sd,
			m_locator l, m_warehouse w 
		where i.c_invoice_id = il.c_invoice_id
		and il.m_product_id = p.m_product_id
		and p.m_product_id = sd.m_product_id
		and date(il.created) = date(now())
		and i.docstatus = 'CO'
		and i.ad_org_id = v_ad_org_id
		and p.isbom = 'N'
		and sd.m_locator_id = l.m_locator_id
		and l.m_warehouse_id = w.m_warehouse_id
		order by m_warehouse_id asc
		)
	LOOP
		if v_cursor.qty < 0 then
			v_qty := v_cursor.qty * -1;
		else
			v_qty := v_cursor.qty;
		end if;
		if v_m_warehouse_id != v_cursor.m_warehouse_id then
		
			if v_bnd = 'Y' then
				M_INOUT_POST(null, v_m_inout_id);
			end if;
		
			v_m_inout_id := get_uuid();

			Ad_Sequence_Doctype('0CD50184705A42CCBECA4EC967646440', v_ad_client_id, 'Y', v_documentno);

			INSERT INTO m_inout(
				m_inout_id, ad_client_id, ad_org_id, 
				createdby, updatedby, documentno, 
				docaction, docstatus, c_doctype_id, 
				movementdate, dateacct, c_bpartner_id, 
				c_bpartner_location_id, m_warehouse_id, deliveryrule, 
				freightcostrule, deliveryviarule, priorityrule, 
				issotrx, processing, posted, 
				processed)
			VALUES (
				v_m_inout_id, v_ad_client_id, v_ad_org_id, 
				v_createdby, v_updatedby, v_documentno, 
				'CO', 'DR', '0CD50184705A42CCBECA4EC967646440', 
				now(), now(), v_c_bpartner_id, 
				v_c_bpartner_location_id, v_cursor.m_warehouse_id, 'A', --m_warehouse_id
				'I', 'P', '5', 
				'Y', 'N', 'N', 
				'N');

			SELECT c_uom_id INTO v_c_uom_id FROM m_product where m_product_id = v_cursor.m_product_id; --m_product_id
			
			v_line := v_line + 10;
			
			-- v_movementqty := v_cursor.qty * -1; --movementqty
			
			INSERT INTO m_inoutline(
				m_inoutline_id, ad_client_id, ad_org_id, 
				createdby, updatedby, line, 
				m_inout_id, m_locator_id, m_product_id, 
				c_uom_id, movementqty, c_bpartner_id, 
				manage_prereservation)
			VALUES (get_uuid(), v_ad_client_id, v_ad_org_id, 
				v_createdby, v_updatedby, v_line, 
				v_m_inout_id, v_cursor.m_locator_id, v_cursor.m_product_id, --m_locator_id, m_product_id
				v_c_uom_id, v_qty, v_c_bpartner_id, 
				'N');
				
			v_bnd = 'Y';
			
		else
			SELECT c_uom_id INTO v_c_uom_id FROM m_product where m_product_id = v_cursor.m_product_id;
			
			v_line := v_line + 10;
			
-- 			v_movementqty := v_cursor.qty * -1;
			
			INSERT INTO m_inoutline(
				m_inoutline_id, ad_client_id, ad_org_id, 
				createdby, updatedby, line, 
				m_inout_id, m_locator_id, m_product_id, 
				c_uom_id, movementqty, c_bpartner_id, 
				manage_prereservation)
			VALUES (get_uuid(), v_ad_client_id, v_ad_org_id, 
				v_createdby, v_updatedby, v_line, 
				v_m_inout_id, v_cursor.m_locator_id, v_cursor.m_product_id, --m_locator_id, m_product_id
				v_c_uom_id, v_qty, v_c_bpartner_id, 
				'N');
				
			v_bnd = 'Y';
		end if;
		
		v_m_warehouse_id := v_cursor.m_warehouse_id;
		
	END LOOP;

	M_INOUT_POST(null, v_m_inout_id);
    
RETURN;
END ASV_GUIA_DESPACHO_LDM
]]></body>
    </function>
  </database>
