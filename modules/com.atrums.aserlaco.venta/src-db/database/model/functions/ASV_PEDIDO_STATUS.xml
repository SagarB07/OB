<?xml version="1.0"?>
  <database name="FUNCTION ASV_PEDIDO_STATUS">
    <function name="ASV_PEDIDO_STATUS" type="NULL">
      <parameter name="p_pinstance_id" type="VARCHAR" mode="in">
        <default/>
      </parameter>
      <body><![CDATA[v_ResultStr VARCHAR(2000):='';
    v_Message VARCHAR(2000):='';
    v_Result NUMBER:=1;
    Cur_Parameter RECORD;
    v_retencion_compra_id VARCHAR(32);
    v_Client_ID VARCHAR(32);
    v_Org_ID VARCHAR(32);
    v_User_ID VARCHAR(32);
    v_docstatus VARCHAR(32);
    v_docaction VARCHAR(32);
    v_asv_pedido_inventario_id VARCHAR(32);
    v_procesar VARCHAR(32);
BEGIN
	DBMS_OUTPUT.PUT_LINE('Updating PInstance - Processing ' || p_PInstance_ID);
	v_ResultStr:='PInstanceNotFound';
	AD_UPDATE_PINSTANCE(p_PInstance_ID, NULL, 'Y', NULL, NULL);
BEGIN 
	FOR Cur_Parameter IN
	  (SELECT i.Record_ID,
	    i.AD_User_ID,
	    p.ParameterName,
	    p.P_String,
	    p.P_Number,
	    p.P_Date,
	    i.AD_Org_ID,
	    i.AD_Client_ID
	  FROM AD_PInstance i
	  LEFT JOIN AD_PInstance_Para p
	    ON i.AD_PInstance_ID=p.AD_PInstance_ID
	  WHERE i.AD_PInstance_ID=p_PInstance_ID
	  ORDER BY p.SeqNo)
	LOOP
	    v_asv_pedido_inventario_id:=Cur_Parameter.Record_ID;
	    v_User_ID:=Cur_Parameter.AD_User_ID;
	    v_Org_ID:=Cur_Parameter.AD_Org_ID;
	    v_Client_ID:=Cur_Parameter.AD_Client_ID;
	    v_docaction := Cur_Parameter.p_string;
	END LOOP;

	DBMS_OUTPUT.PUT_LINE('Updating PInstance - Processing ' || p_PInstance_ID);

	v_docstatus := (select docstatus from asv_pedido_inventario where asv_pedido_inventario_id = v_asv_pedido_inventario_id);
	v_procesar := (select procesar from asv_pedido_inventario where asv_pedido_inventario_id = v_asv_pedido_inventario_id);

	if v_docstatus = 'BR' and v_procesar = 'PR' then
	    update asv_pedido_inventario set docstatus = 'PR', procesar = 'EN'  where asv_pedido_inventario_id = v_asv_pedido_inventario_id;
	end if;

	if v_docstatus = 'PR' and v_procesar = 'EN' then
	    update asv_pedido_inventario set docstatus = 'EN', procesar = 'RC'  where asv_pedido_inventario_id = v_asv_pedido_inventario_id;
	end if;

	if v_docstatus = 'EN' and v_procesar = 'RC' then
		if v_docaction = 'DV' then
			update asv_pedido_inventario set docstatus = 'PR', procesar = 'EN'  where asv_pedido_inventario_id = v_asv_pedido_inventario_id;
		else
			update asv_pedido_inventario set docstatus = 'RC', procesar = 'CR' where asv_pedido_inventario_id =  v_asv_pedido_inventario_id;
		end if;
	end if;

	if v_docstatus = 'RC' and v_procesar = 'CR' then
	    update asv_pedido_inventario set docstatus = 'CR', procesar = 'CR' where asv_pedido_inventario_id =  v_asv_pedido_inventario_id;
	    ASV_GUIA_DESPACHO(v_asv_pedido_inventario_id);
	    ASV_GUIA_INGRESO_LOCAL(v_asv_pedido_inventario_id);
	    ASV_GUIA_INGRESO_DEVOLUCION(v_asv_pedido_inventario_id);
	end if;
	
	DBMS_OUTPUT.PUT_LINE('Updating PInstance - Finished - ' || v_Message) ;
	AD_UPDATE_PINSTANCE(p_PInstance_ID, v_User_ID, 'Y', v_Result, v_Message);
	RETURN;

END;
EXCEPTION
	WHEN OTHERS THEN
		v_ResultStr:= '@ERROR=' || SQLERRM;
		DBMS_OUTPUT.PUT_LINE(v_ResultStr);
		AD_UPDATE_PINSTANCE(p_PInstance_ID, NULL, 'N', 0, v_ResultStr);
	RETURN;
END ASV_PEDIDO_STATUS
]]></body>
    </function>
  </database>
